\let\bf\bfseries
\let\it\itshape
\section{(9) Алгоритм проталкивания предпотока (\groth)}
Этот алгоритм также находит максимальный поток, но отличается от предыдущих описанных алгоритмов тем, что не является вариантом алгоитма Форда-Фалкерсона, а также другой оценкой времени работы~-- $O(|V|^2|E|)$.
\begin{definition}
	{\bf\it Предпотоком} называется функция $f\colon V\times V\to\mathbb{R}$ на вершинах транспортной сети $G=\langle V,E\rangle,s,t$, для которой выполняются следующие свойства:
	\begin{enumerate}
		\item $\forall(u,v)\in V\times V\colon f(u,v)\le c(u,v)$
		\item $\forall(u,v)\in V\times V\colon f(u,v)=-f(v,u)$
		\item $\forall u\in V\smallsetminus\{s\}\colon \sum_{v\in V} f(v,u)\ge0$
	\end{enumerate}
	$e(u)=\sum_{v\in V} f(v,u)$ называется {\bf\it избыточным потоком}.

	Вершина $u\in V$ называется {\bf\it переполненной}, если $e(u)>0$.
\end{definition}
\begin{definition}
	Функция $h\colon V\to\mathbb{N}$ называется {\bf\it функцией высоты}, если выполняются следующие свойства:
	\begin{enumerate}
		\item $h(s)=|V|$
		\item $h(t)=0$
		\item $\forall (u,v)\in E_f\colon h(u)\le h(v)+1$
	\end{enumerate}
\end{definition}
\subsection{Интуитивные соображения}
Представим, что наша сеть~-- это система из резервуаров $V$, соединенных трубами $E$ и находящихся на разной высоте $h$. Предпоток~-- это жидкость, которая течет по трубам, но где-то ее втекает больше, чем вытекает, и она остается в резервуаре (мы предполагаем, что они бесконечные). Можно "перелить"(операция проталкивания) жидкость из резервуара в соединенные трубой резервуары (увеличить значение предпотока на смежных трубах, если выполняются соответствующие интуитивные условия: высота резервуара $u$, из которого переливают, должна быть на единицу больше высоты резервуара $v$, в который переливают, и $c_f(u,v)>0$), находящиеся на меньшей высоте или, если таких не найдется, "поднять"(операция поднятия) резервуар на высоту на единицу большую, чем самый нижний из смежных резервуаров.

Почти очевидно, что в таком случае предпоток превратится в поток. Как будет показано, он будет и максимальным.

\subsection{Операция проталкивания}

\begin{algorithm}
\DontPrintSemicolon
\SetKwIF{If}{ElseIf}{Else}{if}{:}{elif}{else}{}
\SetKwFunction{Push}{Push}
\SetKwProg{Fn}{}{:}{}
\Fn{\Push{$(u, v) \in E$}}{
	\If{$e(u) > 0$ {\normalfont\bf and} $c_f(u,v)>0$ {\normalfont\bf and} $h(u)-h(v)=1$}{
		$d$ := $\min(e(u), c_f(u,v))$ \;
		$f(u,v)$ += $d$\;
		$f(v,u)$ := $-f(u, v)$\;
		$e(u)$ --= `$d$`\;
		$e(v)$ += `$d$`\;
	}
}
\end{algorithm}
Условие $h(u)-h(v)=1$ нужно, так как из отрицания пункта 3 условия на функцию высоты следует, что если высоты различаются больше чем на единицу, остаточных ребер просто нет, поэтому проталкивать что-либо бессмысленно.

Понятно, что предпоток после проталкивания остается предпотоком (сохранение свойств 1, 2 совсем очевидно, свойство 3 сохраняется, потому что мы вычитаем что-то, не превосходит $e(u)$\label{someshit7}).

Проталкивание называется {\bf\it насыщающим}, если после него $c_f(u,v)=0$ (ребро, соответственно, становится {\bf\it насыщенным}). Понятно, что после ненасыщающего проталкивания вершина $u$ перестает быть переполненной (мы так выбираем $d=\min(e(u), c_f(u,v))$, что зануляется либо переполненность, либо остаточная пропускная способность).

\begin{lemma}
	После проталкивания функция высоты остается функцией высоты (не нарушаются ее свойства).
\end{lemma}
\begin{proof}
	Так как высоты не меняются, нужно только проверить, что сохраняется условие 3. Операция может удалить ребро $(u,v)$ из $E_f$ (если $c_f(u,v)<e(u)$) или добавить ребро $(v,u)$, если его не было (так как если $e(u)<c_f(u)$, то $c_{f_\mathrm{new}}(v,u)=c(v,u)+f_\mathrm{new}(u,v)>0=c_f(v,u)$). В первом случае удаление ребра делает неактуальным ограничение. Во втором случае выполняется $h(v)=h(u)+1$, поэтому $h(v)\le h(u)+1$. Поэтому $h$ остается функцией высоты.
\end{proof}
\subsection{Операция подъема}
\begin{algorithm}
	\DontPrintSemicolon
	\SetKwIF{If}{ElseIf}{Else}{if}{:}{elif}{else}{}
	\SetKwFunction{Relabel}{Relabel}
	\SetKwProg{Fn}{}{:}{}
	\Fn{\Relabel{$u\in V$}}{
		\If{$e(u)>0$ {\normalfont\bf and} $\forall v\in \{x|(u,x)\in E_f\}\colon h(u)\le h(v)$}{
			$h(u)$ := $1+\min_{(u,v)\in E_f}\{h(v)\}$\;
		}
	}
\end{algorithm}
\begin{lemma}
	После подъема функция высоты остается функцией высоты (не нарушаются ее свойства).
\end{lemma}
\begin{proof}
	Докажем, что эта функция назначает наибольшую возможную высоту, удовлетворяющую условиям высоты. Так как вершина $u$ переполнена ($e(u)>0$), то существует вершина $v$, для которой $f(v,u)>0$, значит, $c_f(u,v)=c(u,v)-f(u,v)=c(u,v)+f(v,u)>0$, а значит, $(u,v)\in E_f$. Поэтому $\min_{(u,v)\in E_f}\{h(v)\}$ определено и это наибольшее возможное значение, удовлетворяющее условию 3.

	Понятно, что источник и сток выше поднять нельзя, рассмотрим другую вершину к $u$ и входящее в него ребро $(u,v)$. Поскольку высота строго увеличивается ($h(u)\le h(v)$ для всех $(u,v)\in E_f$ до поднятия, а значит, $h(u)<1+h(v)=h_\mathrm{new}(u)$ для такого смежного $v$, что $h(v)$ минимально), выполняется $h(w)\le h(u)+1\le h_{new}(u)+1$
\end{proof}

\subsection{Начальный предпоток}
Начальный предпоток определяется так:
$$
f(u,v)=\begin{cases}
	c(u,v), & u=s,\\
	-c(u,v), & v=s,\\
	0, & \mathrm{otherwise}
\end{cases}
$$
Начальная высота определяется так:
$$
h(u)=\begin{cases}
	|V|, & u=s,\\
	0, & \mathrm{otherwise}
\end{cases}
$$
Это действительно корректно определенная функция высоты, поскольку единственные ребра, для которых не выполняется условие 3~-- это ребра, выходящие из источника, но так как для них значение предпотока равно значению пропускной способности, их нет в $E_f$.

\subsection{Алгоритм. Его корректность.}
Для начала нужно доказать лемму:
\begin{lemma}\label{someshit8}
	Пусть $G,s,t$~-- транспортная сеть с предпотоком $f$ и какой-то функцией высоты $h$. Тогда к любой переполненной вершине можно применить либо проталкивание, либо подъем.
\end{lemma}
\begin{proof}
	Для $(u,v)\in E_f$ выполняется $h(u)\le h(v)+1$ (по условию на высоту). Если $h(u)-h(v)=1$ для какой-то вершины $v$, то выполняется операция проталкивания, а иначе $h(u)<h(v)+1\Rightarrow h(u)\le h(v)$ $\forall (u,v)\in E_f$, а значит, выполнима операция подъема.
\end{proof}
Понятно, что они не могут быть выполнены одновременно.

Теперь мы можем написать алгоритм:

\begin{algorithm}[H]
	\DontPrintSemicolon
	\SetKwIF{If}{ElseIf}{Else}{if}{:}{elif}{else}{}
	\SetKwFor{For}{for}{:}{}
	\SetKwFor{While}{while}{:}{}
	\SetKwFor{ForEach}{foreach}{:}{}
	\SetKwProg{Fn}{}{:}{}
	\SetKwFunction{PPA}{PPA}
	\SetKwFunction{initpreflow}{initialize-preflow}
	\SetKwFunction{Push}{Push}
	\SetKwFunction{Relabel}{Relabel}
	\Fn{\PPA{$G=\langle V,E\rangle$,$c$,$s$,$t$}}{
		\initpreflow{$G$,$s$}\;
		\While{$\exists u\colon\left(\exists v\in V\colon\mathrm{Pushable}(u,v)\right)\vee\mathrm{Relabelable}(u)$}{
			\uIf{$\mathrm{Pushable}((u,v))$}{
				\Push{$(u,v)$}\;
			}
			\Else{\Relabel{$u$}}
		}
	}
\end{algorithm}

\begin{lemma}\label{someshit9}
	$G=\langle V,E\rangle,s,t,f,h$~--- транспортная сеть с источником, стоком, предпотоком и функцией высоты. Тогда нет пути из источника в сток в $G_f$.
\end{lemma}
\begin{proof}
	Предположим, что существует такой путь $v_0=s\to v_1\to\cdots\to v_{k-1}\to t=v_k, (v_i,v_i+1)\in E_f$.
	Можно считать, что этот путь простой, а поэтому $k<|V|$.
	Кроме того, $h(v_i)\le h(v_{i+1})+1\,\forall 0\le i\le k-1$. Но, сложив все эти неравенства, мы получим, что $h(s)\le h(t)+k\Rightarrow |V|\le 0+k$. Противоречие.
\end{proof}
\begin{theorem}[О корректности]
	После окончания работы алгоритма $f$ становится максимальным потоком.
\end{theorem}
\begin{proof}
	Понятно, что $f$, инициализированный в \texttt{initialize\_preflow}, является предпотоком.

	В процессе выполнения алгоритма производятся операции проталкивания и поднятия, которые, как мы уже знаем, оставляют $f$ и $h$ предпотоком и функцией высоты.

	После окончания работы все вершины, кроме $s$ и $t$ должны иметь избыточный поток 0 (по лемме~\ref{someshit8}). Поэтому это поток. По лемме~\ref{someshit9} нет пути из источника в сток, а значит по теореме~\ref{maxflowmincut} этот поток~--- максимальный.
\end{proof}

\subsection{Время работы}
\begin{lemma}\label{path}
	$G,s,t,f$~-- Транспортная сеть с предпотоком. Тогда для любой вершины $u$ с ненулевым избыточным потоком существует простой путь $u\to s$ в $G_f$.
\end{lemma}
\begin{proof}
	Пусть $U=\{v|\exists p\colon u\to v\text{ ~--- простой путь в }G_f\}$. Предположим, что $s\not\in U$.

	Заметим, что $\forall v\in U, w\in V\smallsetminus U\colon f(w,v)\le 0$, так как если бы $f(w,v)>0$, то $f(v,w)<0\Rightarrow c_f(v,w)>0$, а значит $(v,w)\in E_f$ и существует простой путь $u\to v\to w$, что противоречит выбору $w$.

	Отсюда следует, что
	$$
	\sum_{x\in U}e(x)=\sum_{x\in U}\sum_{v\in V}f(v,x)=\sum_{y\in V\smallsetminus U}\sum_{x\in U}f(y,x)+\sum_{y\in U}\sum_{x\in U}f(y,x)=\sum_{y\in V\smallsetminus U}\sum_{x\in U}f(y,x)\le 0
	$$
	Поскольку избыточные потоки неотрицательны для любой вершины, кроме $s$, а $s\not\in U$, то все избыточные потоки нулевые, а значит $e(u)=0$, что противоречит условию.
\end{proof}
\begin{lemma}[Ограничение на функцию высоты]
	Во время работы алгоритма $\forall u\in V\colon h(u)\le 2|V|-1$.
\end{lemma}
\begin{proof}
	$$h(s)=|V|\le 2|V|-1$$
	$$h(t)=0\le 2|V|-1$$
	Для $u\in V\smallsetminus\{s,t\}$ в начале алгоритма $h(u)=0$. После операции поднятия вершина переполнена, а значит есть простой путь $v_0=u\to v_1\to\cdots\to s=v_k$ (по лемме~\ref{path}), а значит, $k\le |V|-1$. По условию на высоту $h(v_i)\le h(v_{i+1})+1$. Складывая неравенства, получаем $h(u)\le h(s)+k\le |V|+|V|-1$.
\end{proof}
\begin{theorem}[Оценка времени]
	Алгоритм выполняется за время $O(|V|^2|E|)$.
\end{theorem}
\begin{proof}Построим ограничение на каждую из операций: на поднятия, насыщающие и ненасыщающие проталкивания.

{\bf Операций поднятия меньше чем $2|V|^2$.} Тут все совсем просто. Подниматься могут $|V\smallsetminus\{s,t\}|=|V|-2$ вершин и, так как изначально все высоты 0, а верхняя граница $2|V|-1$, всего поднятий не больше $(|V|-2)(2|V|-1)<2|V|^2$.

{\bf Операций насыщающих проталкиваний меньше чем $2|V||E|$.} (напомню, что насыщающим проталкиванием вдоль ребра $(u,v)$ называется такое, что после него $c_f(u,v)=0$.) Будем считать проталкивания вдоль $(u,v)$ и вдоль $(v,u)$ вместе. Когда произошло проталкивание вдоль $(u,v)$, выполнялось $h(u)=h(v)+1$. чтобы оно произошло еще раз, должно произойти проталкивание вдоль $(v,u)$, для которого требуется $h(v)=h(u)+1$, поэтому высота $u$ должна увеличиться (уменьшиться она не может) хотя бы на 2. Из ограничения на высоту получаем, что насыщающих увеличений вдоль $(u,v)$ или $(v,u)$ должно быть меньше $\frac{2|V|-1}{2}+\frac{2|V|-1}{2}<2|V|$. Значит всего насыщающих увеличений вдоль любого ребра должно быть меньше $2|V||E|$.

{\bf Операций ненасыщающих проталкиваний меньше чем $4|V|^2(|V|+|E|)$.} Рассмотрим величину $\Phi=\sum\limits_{\mathclap{\substack{v\in V\\e(v)>0}}}h(v)$. Понятно, что $\Phi\ge0$. В начале и в конце выполнения алгоритма $\Phi=0$ (в конце, потому что у потока единственная переполненная вершина~-- это $t$, но ее высота 0) и оно может измениться после любой из оперций, однако при поднятии и насыщающем проталкивании значение обязательно вырастет меньше чем на $2|V|$: первое~--- из ограничения на высоту, а второе~-- из того, что только одна вершина $v$ (если проталкивать вдоль $(u,v)$) может стать переполненной, а ее высота меньше строго меньше $2|V|$.
При ненасыщающем же проталкивании $\Phi$ уменьшается хотя бы на 1: пусть мы проталкиваем вдоль $(u,v)$. После него $e(u)=0$, поэтому $\Phi$ уменьшилась на $h(u)$, а вершина $v$ могла стать, а могла не стать переполненной. Если она не стала, то она не влияет на $\Phi$, а если стала, то к $\Phi$ добавилось $h(v)$, но так как $h(u)-h(v)=1$, $\Phi$ уменьшилось на 1.
Из прошлых пунктов мы знаем количество увеличений и насыщающих проталкиваний, а значит знаем верхнюю границу на $\Phi$: $\Phi<(2|V|)(2|V|^2)+(2|V|)(2|V||E|)=4|V|^2(|V|+|E|)$. Так как $\Phi$ в конце становится нулем, ненасыщающих проталкиваний меньше чем $4|V|^2(|V|+|E|)$.

Из всего этого получается оценка на количество операций. $O(2|V|^2+2|V||E|+4|V|^2(|V|+|E|))=O(|V|^2|E|)$ (напомню, что у нас связный граф, а значит, $|V|\le |E|+1$).

Если хранить список переполненных вершин и для каждой вершины хранить список менее высоких соседей, то операция проталкивания реализуется за $O(1)$, а операция поднятия за $O(|V|)$ (поскольку нужно вычислить минимум). Понятно, что при такой структуре выбор операции реализуется за $O(1)$, что дает оценку времени.
\end{proof}
